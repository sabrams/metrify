<% require_highcharts %>
<script type="text/javascript" charset="utf-8">
  DashboardBreakdown = Class.create({
    initialize : function(series_data){
      this.get_chart(series_data);
    },
    get_chart : function(data){
      if(this.chart){ return this.chart; }
      this.chart = new Highcharts.Chart({
  	    chart: {
  	      renderTo: "stat_chart"
        },
        title: {
          text: "All Stats"
        },
        xAxis: {
         type: "datetime" 
        },
        yAxis: {
          title: {
            text: "Value"
          }
        },
        series: data
      });
    },
    create_new_chart : function(stat_names){  
      var filters = get_filter_values();
      // var params = $H({names : stat_names || [], filters : filters || []}).toQueryString();
      params = filters;
      var url = ["/metrics/chart_data.json", params].join('?');
      new Ajax.Request(url, {onSuccess : function(trans){
        this.chart = null;
        this.get_chart(eval(trans.responseText));
      }.bind(this)})
    }
  });
</script>

<% if @unit == "day" %>
  <%= link_to "Show By Week", :action => "graph_stats", :unit=>"week", :stat_names => @stat_names %>
<% else %>
  <%= link_to "Show By Day", :action => "graph_stats", :unit=>"day", :stat_names => @stat_names %>
<% end %>
<%= link_to "Metrics Home", metrics_path %>
<% showDateRangeOptions = "" 
showDateRangeOptions += "$(\'dateRangeOptions\').style.display = \'block\';\n" %>
<div id="stat_chart" style="width:auto;height:400px;background-color:white"></div>
<% SiteStat.filters.each_pair do |k,v| %>
<div><br>
  <%= k %>
  <% v.each do |name| %>
    <input type="checkbox" id="<%= 'filters[' + k + '[' + name + ']]' %>" name="<%= 'filters_' + k %>"  onClick="dashboard.create_new_chart();"/><%= name %><br>
  <% end %>    
<% end %>
<input type="button" value="Click Here" onUnclick="dashboard.create_new_chart();">
<!-- this to controller and replace this with ajax also -->
<script type="text/javascript" charset="utf-8"> 
  var data = <%= @stat_names.map{|s| {:name => pretty_col_name(s), 
                                  :pointInterval => (1.send(@unit) * 1000), 
                                  :pointStart => (@number_of_stats.send(@unit).ago.to_i * 1000), 
                                  :data => get_stat_arr(s)}}.to_json %>;
  window.dashboard = new DashboardBreakdown(data);

  function get_filter_values()
  {
    var paramStrings = "";
    var first = true;
    var radioValues = new Array();
    <% SiteStat.filters.each_pair do |k,v| %>
      <% v['set'].each do |name| %>
      var param = "<%= 'filters[' + k + '[' + name + ']]' %>";
      var value = document.getElementById(param).value;
      if (!first) {
        paramStrings = paramStrings + "&";
      }
      // if (value != null && value != '') {
      //         paramStrings = paramStrings + param;
      //       }
      
      if (value != null && value != '') {
                    paramStrings = paramStrings + param + "=" + true;
                  }
                  else {
                    paramStrings = paramStrings + param + "=" + false;
                  }
      
      first = false;
      <% end %>
    <% end %>
    // alert(paramStrings);
    return paramStrings;
  }

</script>